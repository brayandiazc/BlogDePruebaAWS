# Configuraci√≥n de Amazon S3 para Active Storage

Una vez creado tu usuario IAM y guardadas tus credenciales, el siguiente paso es configurar un bucket de **Amazon S3** que servir√° como almac√©n para los archivos subidos por tu aplicaci√≥n Rails a trav√©s de Active Storage.

## 1. Crear el Bucket de S3 ü™£

Un bucket es como una carpeta ra√≠z en la nube donde se guardar√°n tus archivos.

1. **Inicia sesi√≥n en la Consola de AWS** con tu usuario IAM.
2. En la barra de b√∫squeda superior, escribe **"S3"** y selecciona el servicio.
3. Haz clic en el bot√≥n naranja **"Create bucket"** (Crear bucket).
4. **Configura los detalles del bucket:**
   - **Bucket name:** El nombre debe ser **√∫nico a nivel mundial** en todo AWS. Usa una convenci√≥n clara, como `[tu-proyecto]-assets-[un-identificador]`. Por ejemplo: `blog-rails-assets-12345`. **Usa solo letras min√∫sculas, n√∫meros y guiones.**
   - **AWS Region:** Elige la misma regi√≥n donde planeas desplegar tu servidor EC2 y base de datos RDS para minimizar la latencia y los costos de transferencia de datos. Ejemplo: `us-east-1` (N. Virginia).
   - **Object Ownership:** Deja la opci√≥n recomendada: **"ACLs disabled"**.
   - **Block Public Access settings for this bucket:** Para que las im√°genes de un blog sean visibles en internet, **debes desmarcar la casilla "Block all public access"**.
     - AWS te mostrar√° una advertencia. Lee y marca la casilla de confirmaci√≥n: _"I acknowledge that the current settings might result in this bucket and the objects within becoming public."_
   - **Bucket Versioning:** D√©jalo en **"Disable"** por ahora.
   - **Default encryption:** Deja la opci√≥n por defecto **"Server-side encryption with Amazon S3 managed keys (SSE-S3)"**.
5. Revisa la configuraci√≥n y haz clic en **"Create bucket"**.

## 2. Configurar la Pol√≠tica del Bucket (Bucket Policy) üìú

Ahora que el bucket no bloquea el acceso p√∫blico, debemos crear una regla expl√≠cita que permita a los navegadores **leer** (pero no escribir o borrar) los objetos.

1. En la lista de buckets, haz clic en el **nombre de tu nuevo bucket**.

2. Ve a la pesta√±a **"Permissions"** (Permisos).

3. Busca la secci√≥n **"Bucket policy"** y haz clic en **"Edit"**.

4. Pega la siguiente pol√≠tica JSON. **Recuerda reemplazar `tu-nombre-de-bucket-unico` con el nombre exacto que le diste a tu bucket.**

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": "*",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::tu-nombre-de-bucket-unico/*"
    }
  ]
}
```

5. Haz clic en **"Save changes"**.

   - **¬øQu√© hace esto?** `Principal: "*"` significa "cualquier persona en internet". `Action: "s3:GetObject"` es el permiso para leer/descargar un archivo. `Resource` especifica que se aplica a todos los objetos (`/*`) dentro de tu bucket.

## 3. Configurar CORS (Cross-Origin Resource Sharing) ‚ÜîÔ∏è

Esta configuraci√≥n es crucial para permitir que tu aplicaci√≥n web, alojada en un dominio (ej. `www.tu-blog.com`), solicite y muestre las im√°genes alojadas en el dominio de S3.

1. Dentro de la misma pesta√±a **"Permissions"**, despl√°zate hacia abajo hasta encontrar la secci√≥n **"Cross-origin resource sharing (CORS)"**.

2. Haz clic en **"Edit"**.

3. Pega la siguiente configuraci√≥n JSON que me proporcionaste. Es excelente y cubre todas las necesidades de Active Storage.

```json
[
  {
    "AllowedHeaders": ["*"],
    "AllowedMethods": ["PUT", "POST", "GET", "DELETE", "HEAD"],
    "AllowedOrigins": ["*"],
    "ExposeHeaders": [],
    "MaxAgeSeconds": 3000
  }
]
```

4. Haz clic en **"Save changes"**.

   - **Nota de producci√≥n:** El `AllowedOrigins: "*"` es muy permisivo. Para un entorno de producci√≥n real, es una buena pr√°ctica reemplazar `"*"` por el dominio de tu aplicaci√≥n (ej. `"https://www.tu-blog.com"`).

## 4. Configurar tu Aplicaci√≥n Rails üíé

Ahora conectamos tu aplicaci√≥n Rails con el bucket de S3 que acabamos de preparar.

1. **A√±ade la gema de AWS:**
   Abre tu `Gemfile` y a√±ade la gema oficial del SDK de AWS para S3.

```ruby
# Gemfile
gem 'aws-sdk-s3', require: false
```

Luego, ejecuta `bundle install` en tu terminal.

2. **Configura el servicio de almacenamiento:**
   Abre `config/storage.yml` y configura el servicio `amazon` con los datos de tu bucket. Usaremos variables de entorno para mantener seguras tus credenciales.

   ```yaml
   # config/storage.yml
   amazon:
     service: S3
     access_key_id: <%= ENV["AWS_ACCESS_KEY_ID"] %>
     secret_access_key: <%= ENV["AWS_SECRET_ACCESS_KEY"] %>
     region: tu-region-aws # Escribe aqu√≠ la misma regi√≥n que elegiste para el bucket
     bucket: tu-nombre-de-bucket-unico # Escribe aqu√≠ el nombre de tu bucket
   ```

   > **Buena pr√°ctica:** Usar `ENV[...]` evita que tus claves secretas queden expuestas en el c√≥digo fuente. Estas variables se configurar√°n directamente en el servidor (EC2) o en un archivo `.env` para desarrollo local.

3. **Activa el servicio en tu entorno:**
   Para producci√≥n, abre `config/environments/production.rb` y aseg√∫rate de que esta l√≠nea est√© presente:

```ruby
# config/environments/production.rb
config.active_storage.service = :amazon
```

## 5. Probar la Configuraci√≥n Localmente (Recomendado) ‚úÖ

Antes de desplegar, verifica que todo funciona desde tu m√°quina de desarrollo.

1. **Instala `dotenv-rails`:**
   Esta gema carga las variables de entorno desde un archivo `.env`. A√±√°dela a tu `Gemfile` dentro del grupo de desarrollo:

```ruby
# Gemfile
group :development, :test do
   gem 'dotenv-rails'
end
```

Ejecuta `bundle install`.

2. **Crea tu archivo `.env`:**
   En la ra√≠z de tu proyecto, crea un archivo llamado `.env`. **¬°Aseg√∫rate de que `.env` est√© en tu archivo `.gitignore` para no subirlo nunca a un repositorio\!**

```
# .env
AWS_ACCESS_KEY_ID="TU_ACCESS_KEY_ID_DE_IAM"
AWS_SECRET_ACCESS_KEY="TU_SECRET_ACCESS_KEY_DE_IAM"
```

Pega las credenciales que guardaste al crear tu usuario IAM.

3. **Activa S3 en desarrollo:**
   Abre `config/environments/development.rb` y cambia el servicio de almacenamiento:

```ruby
# config/environments/development.rb
config.active_storage.service = :amazon # Cambia :local por :amazon
```

4. **¬°Prueba\!**
   Reinicia tu servidor (`rails s`) e intenta subir un archivo a trav√©s de tu aplicaci√≥n. Si la configuraci√≥n es correcta, el archivo no se guardar√° localmente, sino que aparecer√° directamente en tu bucket de S3.
